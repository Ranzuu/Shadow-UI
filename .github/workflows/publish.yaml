name: Publish to Modrinth & CurseForge

on:
  workflow_run:
    workflows: ["Build and Release Resource Pack"]
    types: [completed]

permissions:
  contents: read

jobs:
  publish:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest

    steps:
      - name: Debug workflow_run context
        shell: bash
        run: |
          echo "Workflow:     ${{ github.event.workflow_run.name }}"
          echo "Conclusion:   ${{ github.event.workflow_run.conclusion }}"
          echo "Head SHA:     ${{ github.event.workflow_run.head_sha }}"
          echo "Head branch:  ${{ github.event.workflow_run.head_branch }}"
          echo "Repo:         ${{ github.repository }}"

      - name: Find matching GitHub Release by commit SHA
        id: rel
        shell: bash
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail

          SHA="${{ github.event.workflow_run.head_sha }}"
          echo "Looking for release with target_commitish == $SHA"

          # Get recent releases and find the one created from this exact commit
          # (Your release tags are v2.8.X/v*, so we filter to that namespace too)
          TAG="$(gh api "repos/${{ github.repository }}/releases?per_page=50" \
            --jq ".[] | select(.tag_name | startswith(\"v2.8.X/\")) | select(.target_commitish == \"$SHA\") | .tag_name" \
            | head -n 1)"

          if [ -z "${TAG:-}" ]; then
            echo "ERROR: No matching release found for commit $SHA."
            echo "This usually means the release wasn't created from this commit, or GitHub hasn't indexed it yet."
            echo "Recent releases:"
            gh api "repos/${{ github.repository }}/releases?per_page=10" --jq '.[] | {tag: .tag_name, target: .target_commitish, published: .published_at}'
            exit 1
          fi

          PACK_VERSION="${TAG#v2.8.X/}"  # e.g. v4.28

          echo "Found TAG=$TAG"
          echo "Parsed PACK_VERSION=$PACK_VERSION"

          echo "TAG=$TAG" >> "$GITHUB_OUTPUT"
          echo "PACK_VERSION=$PACK_VERSION" >> "$GITHUB_OUTPUT"

      - name: Fetch release body (changelog) from GitHub Release
        id: notes
        shell: bash
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          BODY="$(gh release view "${{ steps.rel.outputs.TAG }}" --repo "${{ github.repository }}" --json body --jq .body)"
          # Put body into a multiline output
          delim="REL_BODY_$(date +%s%N)"
          {
            echo "body<<$delim"
            echo "$BODY"
            echo "$delim"
          } >> "$GITHUB_OUTPUT"

          echo "Changelog preview (first 20 lines):"
          echo "$BODY" | sed -n '1,20p'

      - name: Download release assets (ZIPs)
        shell: bash
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          mkdir -p dist
          gh release download "${{ steps.rel.outputs.TAG }}" \
            --repo "${{ github.repository }}" \
            --pattern "*.zip" \
            --dir dist

          echo "Downloaded files:"
          ls -la dist

      - name: Detect main + modernity ZIP names
        id: zips
        shell: bash
        run: |
          set -euo pipefail

          # Your filenames contain "Modernity version" for the modernity file.
          MAIN_ZIP="$(ls -1 dist/*.zip | grep -vi "modernity" | head -n 1 || true)"
          MODERNITY_ZIP="$(ls -1 dist/*.zip | grep -i "modernity" | head -n 1 || true)"

          if [ -z "$MAIN_ZIP" ] || [ -z "$MODERNITY_ZIP" ]; then
            echo "ERROR: Could not find both ZIPs."
            echo "All ZIPs found:"
            ls -la dist/*.zip || true
            exit 1
          fi

          echo "MAIN_ZIP=$MAIN_ZIP" >> "$GITHUB_OUTPUT"
          echo "MODERNITY_ZIP=$MODERNITY_ZIP" >> "$GITHUB_OUTPUT"

          echo "MAIN_ZIP: $MAIN_ZIP"
          echo "MODERNITY_ZIP: $MODERNITY_ZIP"

      # Modrinth (2 versions)
      - name: Upload to Modrinth (Main)
        uses: cloudnode-pro/modrinth-publish@v2
        with:
          token: ${{ secrets.MODRINTH_TOKEN }}
          project: OFx9JGCC
          name: Shadow UI ${{ steps.rel.outputs.PACK_VERSION }}
          version: ${{ steps.rel.outputs.PACK_VERSION }}
          changelog: ${{ steps.notes.outputs.body }}
          loaders: |-
            minecraft
          game-versions: |-
            1.7.10
          files: ${{ steps.zips.outputs.MAIN_ZIP }}

      - name: Upload to Modrinth (Modernity)
        uses: cloudnode-pro/modrinth-publish@v2
        with:
          token: ${{ secrets.MODRINTH_TOKEN }}
          project: OFx9JGCC
          name: Shadow UI ${{ steps.rel.outputs.PACK_VERSION }} Modernity Version
          version: ${{ steps.rel.outputs.PACK_VERSION }}-modernity
          changelog: ${{ steps.notes.outputs.body }}
          loaders: |-
            minecraft
          game-versions: |-
            1.7.10
          files: ${{ steps.zips.outputs.MODERNITY_ZIP }}

      # CurseForge (2 files)
      - name: Upload to CurseForge (Main)
        uses: itsmeow/curseforge-upload@v3
        with:
          token: ${{ secrets.CURSEFORGE_TOKEN }}
          project_id: "1351373"
          game_endpoint: "minecraft"
          file_path: ${{ steps.zips.outputs.MAIN_ZIP }}
          display_name: Shadow UI ${{ steps.rel.outputs.PACK_VERSION }}
          changelog: ${{ steps.notes.outputs.body }}
          changelog_type: "markdown"
          release_type: "release"
          game_versions: "Minecraft 1.7.10:1.7.10"

      - name: Upload to CurseForge (Modernity)
        uses: itsmeow/curseforge-upload@v3
        with:
          token: ${{ secrets.CURSEFORGE_TOKEN }}
          project_id: "1351373"
          game_endpoint: "minecraft"
          file_path: ${{ steps.zips.outputs.MODERNITY_ZIP }}
          display_name: Shadow UI ${{ steps.rel.outputs.PACK_VERSION }} Modernity Version
          changelog: ${{ steps.notes.outputs.body }}
          changelog_type: "markdown"
          release_type: "release"
          game_versions: "Minecraft 1.7.10:1.7.10"
